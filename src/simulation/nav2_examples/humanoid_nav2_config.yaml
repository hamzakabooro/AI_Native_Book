# Nav2 Configuration for Humanoid Robots
# This configuration adapts Nav2 for humanoid robot navigation requirements

amcl:
  ros__parameters:
    use_sim_time: True
    alpha1: 0.3
    alpha2: 0.3
    alpha3: 0.3
    alpha4: 0.3
    alpha5: 0.3
    base_frame_id: "base_link"  # Changed from base_footprint for humanoid
    beam_skip_distance: 0.5
    beam_skip_error_threshold: 0.9
    beam_skip_threshold: 0.3
    do_beamskip: False
    global_frame_id: "map"
    lambda_short: 0.1
    laser_likelihood_max_dist: 2.0
    laser_max_range: 100.0
    laser_min_range: -1.0
    laser_model_type: "likelihood_field"
    max_beams: 60
    max_particles: 3000  # More particles for humanoid due to balance considerations
    min_particles: 500
    odom_frame_id: "odom"
    pf_err: 0.05
    pf_z: 0.99
    recovery_alpha_fast: 0.0
    recovery_alpha_slow: 0.0
    resample_interval: 1
    robot_model_type: "nav2_amcl::DifferentialMotionModel"  # Using differential model
    save_pose_interval: 0.5
    sigma_hit: 0.2
    tf_broadcast: True
    transform_tolerance: 1.0
    update_min_a: 0.2
    update_min_d: 0.25
    z_hit: 0.5
    z_max: 0.05
    z_rand: 0.5
    z_short: 0.05

bt_navigator:
  ros__parameters:
    use_sim_time: True
    global_frame: "map"
    robot_base_frame: "base_link"
    odom_topic: "/odom"
    bt_loop_duration: 10
    default_server_timeout: 20
    enable_groot_monitoring: True
    groot_zmq_publisher_port: 1666
    groot_zmq_server_port: 1667
    default_nav_to_pose_bt_xml: "package://nav2_bt_navigator/bt_xml_v0/nav_to_pose_w_replanning_and_recovery.xml"
    default_nav_through_poses_bt_xml: "package://nav2_bt_navigator/bt_xml_v0/nav_through_poses_w_replanning_and_recovery.xml"
    default_nav_to_pose_rclcpp_node_bt_xml: "package://nav2_bt_navigator/bt_xml_v0/nav_to_pose_w_replanning_and_recovery_rclcpp.xml"
    plugin_lib_names:
      - "BackUp"
      - "Spin"
      - "Wait"
      - "ClearEntireCostmap"
      - "RemovePassedGoals"
      - "PlannerSelector"
      - "ControllerSelector"
      - "GoalCheckerSelector"
      - "IsGoalReached"
      - "IsPathValid"
      - "IsGoalValid"
      - "IsBatteryLow"
      - "IsStuck"
      - "IsControllerActive"
      - "IsPlannerActive"
      - "IsRecoveryActive"
      - "ComputePathToPose"
      - "ComputePathThroughPoses"
      - "FollowPath"
      - "SmoothPath"
      - "ComputeVelocityCommands"
      - "WaitAtGoal"
      - "OnFirstPass"
      - "BackUpAndStop"
      - "AvoidCollision"
      - "ProgressChecker"
      - "GoalReachedChecker"
      - "PathSizeChecker"
      - "PathAcceptanceTester"
      - "InitialPoseRecovery"
      - "InflationLayer"
      - "ObstacleLayer"
      - "StaticLayer"
      - "VoxelLayer"
      - "RangeSensorLayer"
      - "VirtualWallLayer"
      - "VelocityFilter"
      - "SimpleActionServer"
      - "SimpleCondition"
      - "SimpleRecovery"
      - "SimpleAction"
      - "PipelineSequence"
      - "RoundRobinNode"
      - "RecoveryNode"
      - "RateController"
      - "DistanceController"
      - "TimeController"
      - "TransformGetter"
      - "IsBatteryCharging"
      - "IsBatteryOperational"
      - "IsBatteryStable"
      - "IsActionServerActive"
      - "IsControllerRunning"
      - "IsLocalizerActive"
      - "IsMapValid"
      - "IsPathReady"
      - "IsRobotStopped"
      - "IsTaskValid"
      - "IsTransformerActive"

controller_server:
  ros__parameters:
    use_sim_time: True
    controller_frequency: 10.0  # Lower frequency for humanoid stability
    min_x_velocity_threshold: 0.05  # Slower for humanoid balance
    min_y_velocity_threshold: 0.05
    min_theta_velocity_threshold: 0.05
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["general_goal_checker"] 
    controller_plugins: ["FollowPath"]
    
    # Progress checker parameters adapted for humanoid
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.25  # Smaller for humanoid steps
      movement_time_allowance: 20.0   # More time for humanoid movement
    
    # Goal checker parameters adapted for humanoid
    general_goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25    # Larger tolerance for humanoid
      yaw_goal_tolerance: 0.25
      stateful: True
    
    # Path follower adapted for humanoid
    FollowPath:
      plugin: "nav2_rotation_shim_controller::RotationShimController"
      # Inner controller for handling actual path following
      inner_controller:
        plugin: "nav2_regulated_pure_pursuit_controller::RegulatedPurePursuitController"
        desired_linear_vel: 0.3   # Slower for humanoid stability
        lookahead_dist: 0.4       # Shorter for more careful navigation
        min_lookahead_dist: 0.2
        max_lookahead_dist: 0.6
        lookahead_time: 1.0       # Adjusted for humanoid dynamics
        rotate_to_heading_angular_vel: 0.3  # Slower rotations
        use_velocity_scaled_lookahead_dist: true
        min_approach_linear_velocity: 0.05
        approach_velocity_scaling_dist: 0.4
        use_approach_vel_scaling: true
        max_allowed_time_to_collision_up_to_carrot: 1.0
        use_regulated_linear_velocity_scaling: true
        use_cost_regulated_linear_velocity_scaling: true
        regulated_linear_scaling_min_radius: 0.5
        regulated_linear_scaling_min_speed: 0.1
        use_rotation_shim: true
        rotation_shim:
          plugin: "nav2_controller::SimpleProgressChecker"
          min_rotational_vel: 0.2
          time_threshold_to_rotate: 1.0
          max_hysteresis_radius: 0.2
          min_hysteresis_radius: 0.1
          hysteresis_factor: 2.0
          xy_goal_tolerance: 0.05

local_costmap:
  ros__parameters:
    use_sim_time: True
    global_frame: "odom"
    robot_base_frame: "base_link"
    update_frequency: 5.0
    publish_frequency: 2.0
    width: 8    # Wider for humanoid stability
    height: 8
    resolution: 0.05
    origin_x: -4.0
    origin_y: -4.0
    rolling_window: True
    plugins: ["obstacle_layer", "voxel_layer", "inflation_layer"]
    obstacle_layer:
      plugin: "nav2_costmap_2d::ObstacleLayer"
      enabled: True
      observation_sources: scan
      scan:
        topic: "/scan"
        max_obstacle_height: 2.0
        clearing: True
        marking: True
        data_type: "LaserScan"
        raytrace_max_range: 4.0  # Longer for humanoid planning
        raytrace_min_range: 0.0
        obstacle_max_range: 3.5  # Longer for humanoid planning
        obstacle_min_range: 0.0
    voxel_layer:
      plugin: "nav2_costmap_2d::VoxelLayer"
      enabled: True
      footprint_clearing_enabled: True
      max_obstacle_height: 2.0
      z_voxels: 16
      z_resolution: 0.15
      unknown_threshold: 15
      mark_threshold: 0
      observation_sources: pointcloud
      pointcloud:
        topic: "/pointcloud"
        max_obstacle_height: 2.0
        min_obstacle_height: 0.0
        obstacle_max_range: 3.5
        obstacle_min_range: 0.1
        raytrace_max_range: 4.0
        raytrace_min_range: 0.0
        clearing: True
        marking: True
        data_type: "PointCloud2"
    inflation_layer:
      plugin: "nav2_costmap_2d::InflationLayer"
      enabled: True
      cost_scaling_factor: 2.5  # Adjusted for humanoid safety
      inflation_radius: 0.7     # Larger for humanoid safety margin
      inflate_to_robot_radius: False
      inflate_around_obstacles: True
      include_unknown: False
    always_send_full_costmap: True

global_costmap:
  ros__parameters:
    use_sim_time: True
    global_frame: "map"
    robot_base_frame: "base_link"
    update_frequency: 1.0
    publish_frequency: 1.0
    width: 100
    height: 100
    resolution: 0.05
    origin_x: -50.0
    origin_y: -50.0
    plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
    obstacle_layer:
      plugin: "nav2_costmap_2d::ObstacleLayer"
      enabled: True
      observation_sources: scan
      scan:
        topic: "/scan"
        max_obstacle_height: 2.0
        clearing: True
        marking: True
        data_type: "LaserScan"
        raytrace_max_range: 5.0
        raytrace_min_range: 0.0
        obstacle_max_range: 4.0
        obstacle_min_range: 0.0
    static_layer:
      plugin: "nav2_costmap_2d::StaticLayer"
      map_subscribe_transient_local: True
    inflation_layer:
      plugin: "nav2_costmap_2d::InflationLayer"
      enabled: True
      cost_scaling_factor: 2.0
      inflation_radius: 0.8  # Larger for humanoid safety
    always_send_full_costmap: True

planner_server:
  ros__parameters:
    expected_planner_frequency: 10.0  # Lower for humanoid path planning
    planner_plugins: ["GridBased"]
    GridBased:
      plugin: "nav2_navfn_planner::NavfnPlanner"
      tolerance: 0.8  # Higher tolerance for humanoid navigation
      use_astar: false
      allow_unknown: true

velocity_smoother:
  ros__parameters:
    smoothing_frequency: 20.0
    scale_velocities: false
    velocity_threshold: 0.0
    velocity_scale: 1.0
    accel_lim_v: 0.5  # Lower acceleration for humanoid stability
    accel_lim_theta: 0.5
    decel_lim_v: -0.5
    decel_lim_theta: -0.5
    odom_topic: "odom"
    robot_base_frame: "base_link"
    cmd_vel_topic: "cmd_vel"
    smoothed_cmd_vel_topic: "cmd_vel_smoothed"
    publisher_queue_size: 10

waypoint_follower:
  ros__parameters:
    loop_rate: 20
    stop_on_failure: false
    waypoint_task_executor_plugin: "wait_at_waypoint"
    wait_at_waypoint:
      plugin: "nav2_waypoint_follower::WaitAtWaypoint"
      enabled: true
      waypoint_pause_duration: 500  # Longer pause for humanoid

# Humanoid-specific parameters
humanoid_locomotion:
  ros__parameters:
    # Balance parameters
    center_of_mass_height: 0.8
    foot_separation: 0.2
    max_step_width: 0.3
    max_step_length: 0.4
    step_clearance: 0.05
    
    # Gait parameters
    walking_speed: 0.3  # m/s
    turning_speed: 0.2  # rad/s
    step_frequency: 0.8  # Hz
    double_support_ratio: 0.2  # 20% of step time in double support
    
    # Safety parameters
    fall_threshold: 0.1  # Radians before fall recovery
    max_lean_angle: 0.15  # Max lean in radians